<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Call Logging Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .container { max-width: 900px; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; background-color: #fff; transition: all 0.2s; }
    .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    .form-label { font-weight: 500; color: #4b5563; }
    .hidden { display: none; }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background-color:white; padding:2rem; border-radius:1rem; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    .cube-button { display:flex; flex-direction:column; justify-content:center; align-items:center; padding:24px; border-radius:12px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor:pointer; }
    .cube-button:hover { transform: translateY(-4px); box-shadow:0 6px 10px rgba(0,0,0,0.15); }
    table { border-collapse: collapse; width:100%; }
    th, td { text-align:left; padding:12px; border-bottom:1px solid #ddd; }
    th { background-color:#f2f2f2; }
    .spinner-container { display: flex; justify-content: center; align-items: center; gap: 8px; }
    .spinner-dot { width: 12px; height: 12px; background-color: #ffffff; border-radius: 50%; animation: bounce 1s ease-in-out infinite; }
    .spinner-dot:nth-child(2) { animation-delay: 0.1s; }
    .spinner-dot:nth-child(3) { animation-delay: 0.2s; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="container bg-white p-8 md:p-12 rounded-2xl shadow-xl space-y-8 border border-gray-200">
  <!-- LOGIN -->
  <div id="loginSection">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Login</h1>
      <p class="mt-2 text-gray-500">Use your coach credentials.</p>
    </div>
    <form id="loginForm" class="mt-8 space-y-4">
      <div>
        <label for="coachId" class="form-label block mb-2">Coach ID</label>
        <input type="text" id="coachId" name="coachId" class="form-input" required>
      </div>
      <div>
        <label for="password" class="form-label block mb-2">Dashboard Password</label>
        <input type="password" id="password" name="password" class="form-input" required>
      </div>
      <button type="submit" id="loginBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700">Log in</button>
    </form>
    <div id="loginMessageBox" class="mt-4 p-4 rounded-xl text-center hidden"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardSection" class="hidden">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Dashboard</h1>
      <p class="mt-2 text-gray-500">Welcome, <span id="coachNameDisplay" class="font-bold text-blue-600"></span>!</p>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
      <div id="monthlyEarningsDisplay" class="cube-button bg-blue-600 text-white cursor-default">
        <p class="text-lg font-medium opacity-80">Monthly Earnings</p>
        <p class="mt-2 text-4xl sm:text-5xl font-bold"><span id="earningsAmount">--</span>‚Ç¨</p>
      </div>
      <button id="logCallBtn" class="cube-button bg-green-600 text-white"><span class="text-4xl">üìù</span><p class="mt-2 text-lg font-semibold">Log a new call</p></button>
      <button id="viewStudentsBtn" class="cube-button bg-orange-600 text-white"><span class="text-4xl">üßë‚Äçüéì</span><p class="mt-2 text-lg font-semibold">Students</p></button>
      <button id="viewFolderBtn" class="cube-button bg-gray-600 text-white"><span class="text-4xl">üìÇ</span><p class="mt-2 text-lg font-semibold">My payment folder</p></button>
      <button id="viewCallLogBtn" class="cube-button bg-purple-600 text-white"><span class="text-4xl">üìñ</span><p class="mt-2 text-lg font-semibold">Call log</p></button>
      <button id="viewReportCardsBtn" class="cube-button bg-teal-600 text-white"><span class="text-4xl">üìà</span><p class="mt-2 text-lg font-semibold">Report Cards</p></button>
      <button id="logoutBtn" class="cube-button bg-red-600 text-white sm:col-span-2 lg:col-span-1"><span class="text-4xl">üö™</span><p class="mt-2 text-lg font-semibold">Log out</p></button>
    </div>
  </div>

  <!-- CALL FORM -->
  <div id="callSection" class="hidden">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Log a new call</h1>
      <p class="mt-2 text-gray-500">Logged in as <span id="callSectionCoachNameDisplay" class="font-bold text-blue-600"></span>.</p>
    </div>
    <label><input type="radio" name="callType" value="IND" checked> IND</label>
    <label><input type="radio" name="callType" value="GROUP"> GROUP</label>

    <form id="callForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
      <input type="hidden" id="coachName" name="coachName">
      <input type="hidden" id="units" name="units">
      <input type="hidden" id="contractId" name="contractId">
      <input type="hidden" id="productId" name="productId">

      <!-- Student (IND only) -->
      <div id="studentIdContainer">
        <label for="studentId" class="form-label block mb-2">Student ID</label>
        <select id="studentId" name="studentId" class="form-input">
          <option value="" disabled selected>Loading Student IDs...</option>
        </select>
      </div>

      <!-- Product -->
      <div>
        <label for="productIdSelect" class="form-label block mb-2">Product</label>
        <select id="productIdSelect" name="productIdSelect" class="form-input" required disabled>
          <option value="" disabled selected>Select a Student ID first</option>
        </select>
      </div>

      <!-- Group students -->
      <div id="groupStudentsContainer" class="hidden md:col-span-2">
        <label for="groupStudentIds" class="form-label block mb-2">Select Students</label>
        <select id="groupStudentIds" name="groupStudentIds" class="form-input" multiple>
          <option value="" disabled>Select a product first</option>
        </select>
      </div>

      <!-- Date -->
      <div>
        <label for="callDate" class="form-label block mb-2">Date</label>
        <input type="date" id="callDate" name="callDate" class="form-input" required>
      </div>
      <!-- Rate -->
      <div>
        <label for="hourlyRate" class="form-label block mb-2">Coach Rate (‚Ç¨)</label>
        <input type="number" id="hourlyRate" class="form-input" readonly>
      </div>
      <!-- Duration -->
      <div>
        <label for="technicalDuration" class="form-label block mb-2">Duration (minutes)</label>
        <input type="number" id="technicalDuration" class="form-input" readonly>
      </div>
      <!-- Override -->
      <div>
        <label for="callDuration" class="form-label block mb-2">Duration Override</label>
        <select id="callDuration" class="form-input">
          <option value="30">30</option>
          <option value="60" selected>60</option>
          <option value="90">90</option>
          <option value="120">120</option>
        </select>
      </div>

      <div class="md:col-span-2 mt-4">
        <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700">Log Call</button>
        <button type="button" id="backToDashboardBtn" class="w-full mt-2 bg-gray-400 text-white py-3 px-6 rounded-xl hover:bg-gray-500">Back to Dashboard</button>
      </div>
    </form>
    <div id="callMessageBox" class="mt-8 p-4 rounded-xl text-center hidden"></div>
  </div>

  <!-- (STUDENTS, HISTORY, REPORTS ‚Üí restano identici al tuo) -->

</div>

<script>
  const base_url = "https://vercel-python-proxy.vercel.app/api";
  const deployment_id = "AKfycbwjmnBDZcMdBmP6Dj67S19qGDP61ujNtBvJZU65xqlUfluThOy1pphwjvACS9FVXJeD";

  const studentIdSelect = document.getElementById('studentId');
  const productIdSelect = document.getElementById('productIdSelect');
  const groupStudentsContainer = document.getElementById('groupStudentsContainer');
  const groupStudentIds = document.getElementById('groupStudentIds');

  const hourlyRateInput = document.getElementById('hourlyRate');
  const technicalDurationInput = document.getElementById('technicalDuration');
  const contractIdInput = document.getElementById('contractId');
  const callDurationSelect = document.getElementById('callDuration');
  const unitsInput = document.getElementById('units');

  async function apiGet(action, params={}) {
    const url = new URL(base_url+"/get");
    url.searchParams.set("deployment_id", deployment_id);
    url.searchParams.set("action", action);
    Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
    const res = await fetch(url);
    return res.json();
  }

  // toggle call type
  document.querySelectorAll('input[name="callType"]').forEach(radio=>{
    radio.addEventListener('change', ()=>{
      if(radio.value==="GROUP" && radio.checked){
        studentIdSelect.disabled=true;
        studentIdSelect.innerHTML='<option value="">Not used in GROUP</option>';
        groupStudentsContainer.classList.remove('hidden');
        loadGroupProducts();
      } else if(radio.value==="IND" && radio.checked){
        groupStudentsContainer.classList.add('hidden');
        loadStudentIds();
      }
    });
  });

  async function loadStudentIds(){
    const resp=await apiGet('getStudents');
    const students=resp.students||[];
    studentIdSelect.innerHTML='<option disabled selected>Select Student</option>';
    students.forEach(id=>{
      const o=document.createElement('option');o.value=id;o.textContent=id;studentIdSelect.appendChild(o);
    });
  }

  studentIdSelect.addEventListener('change', async()=>{
    const resp=await apiGet('getStudentContracts',{studentId:studentIdSelect.value});
    const contracts=resp.contracts||[];
    productIdSelect.disabled=false;
    productIdSelect.innerHTML='<option disabled selected>Select product</option>';
    contracts.forEach(c=>{
      const o=document.createElement('option');
      o.value=c.productId;
      o.textContent=`${c.product.name} (${c.contractId})`;
      o.dataset.contractId=c.contractId;
      o.dataset.rate=c.product.senior; // semplificazione, backend calcola il vero rate
      o.dataset.duration=c.product.duration;
      productIdSelect.appendChild(o);
    });
  });

  async function loadGroupProducts(){
    const resp=await apiGet('getGroupProducts');
    const prods=resp.products||[];
    productIdSelect.disabled=false;
    productIdSelect.innerHTML='<option disabled selected>Select group product</option>';
    prods.forEach(p=>{
      const o=document.createElement('option');o.value=p.productId;o.textContent=p.productName;productIdSelect.appendChild(o);
    });
  }

  productIdSelect.addEventListener('change', async()=>{
    const callType=document.querySelector('input[name="callType"]:checked').value;
    if(callType==="GROUP"){
      const resp=await apiGet('getGroupStudents',{productId:productIdSelect.value});
      const studs=resp.students||[];
      groupStudentIds.innerHTML='';
      studs.forEach(sid=>{
        const o=document.createElement('option');o.value=sid;o.textContent=sid;groupStudentIds.appendChild(o);
      });
    }else{
      const opt=productIdSelect.options[productIdSelect.selectedIndex];
      hourlyRateInput.value=opt.dataset.rate||'';
      technicalDurationInput.value=opt.dataset.duration||'';
      contractIdInput.value=opt.dataset.contractId||'';
      unitsInput.value=(parseFloat(callDurationSelect.value||60)/60).toFixed(2);
    }
  });

  callDurationSelect.addEventListener('change', ()=>{
    unitsInput.value=(parseFloat(callDurationSelect.value||60)/60).toFixed(2);
  });
</script>
</body>
</html>
