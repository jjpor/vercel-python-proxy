<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Call Logging Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 900px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; background-color: #fff; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .form-label { font-weight: 500; color: #4b5563; }
        .hidden { display: none; }
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background-color:white; padding:2rem; border-radius:1rem; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
        .cube-button { display:flex; flex-direction:column; justify-content:center; align-items:center; padding:24px; border-radius:12px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor:pointer; }
        .cube-button:hover { transform: translateY(-4px); box-shadow:0 6px 10px rgba(0,0,0,0.15); }
        table { border-collapse: collapse; width:100%; }
        th, td { text-align:left; padding:12px; border-bottom:1px solid #ddd; }
        th { background-color:#f2f2f2; }

        /* Spinner styles */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .spinner-dot {
            width: 12px;
            height: 12px;
            background-color: #ffffff;
            border-radius: 50%;
            animation: bounce 1s ease-in-out infinite;
        }
        .spinner-dot:nth-child(2) {
            animation-delay: 0.1s;
        }
        .spinner-dot:nth-child(3) {
            animation-delay: 0.2s;
        }
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container bg-white p-8 md:p-12 rounded-2xl shadow-xl space-y-8 border border-gray-200">
        <!-- Login -->
        <div id="loginSection">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Login</h1>
                <p class="mt-2 text-gray-500">Use your coach credentials.</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-4">
                <div>
                    <label for="coachId" class="form-label block mb-2">Coach ID</label>
                    <input type="text" id="coachId" name="coachId" class="form-input" placeholder="e.g., MA" required>
                </div>
                <div>
                    <label for="password" class="form-label block mb-2">Dashboard Password</label>
                    <input type="password" id="password" name="password" class="form-input" placeholder="Password" required autocomplete="current-password">
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-blue-400 disabled:cursor-not-allowed">
                    Log in
                </button>
            </form>
            <div id="loginMessageBox" class="mt-4 p-4 rounded-xl text-center hidden"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboardSection" class="hidden">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Dashboard</h1>
                <p class="mt-2 text-gray-500">Welcome, <span id="coachNameDisplay" class="font-bold text-blue-600"></span>!</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                <div id="monthlyEarningsDisplay" class="cube-button bg-blue-600 text-white cursor-default">
                    <p class="text-lg font-medium opacity-80">Monthly Earnings</p>
                    <p class="mt-2 text-4xl sm:text-5xl font-bold"><span id="earningsAmount">--</span>‚Ç¨</p>
                </div>

                <button id="logCallBtn" class="cube-button bg-green-600 text-white">
                    <span class="text-4xl">üìù</span>
                    <p class="mt-2 text-lg font-semibold">Log a new call</p>
                </button>

                <button id="viewStudentsBtn" class="cube-button bg-orange-600 text-white">
                    <span class="text-4xl">üßë‚Äçüéì</span>
                    <p class="mt-2 text-lg font-semibold">Students</p>
                </button>

                <button id="viewFolderBtn" class="cube-button bg-gray-600 text-white">
                    <span class="text-4xl">üìÇ</span>
                    <p class="mt-2 text-lg font-semibold">My payment folder</p>
                </button>

                <button id="viewCallLogBtn" class="cube-button bg-purple-600 text-white">
                    <span class="text-4xl">üìñ</span>
                    <p class="mt-2 text-lg font-semibold">Call log</p>
                </button>
                
                <button id="viewReportCardsBtn" class="cube-button bg-teal-600 text-white">
                    <span class="text-4xl">üìà</span>
                    <p class="mt-2 text-lg font-semibold">Report Cards</p>
                </button>

                <button id="logoutBtn" class="cube-button bg-red-600 text-white sm:col-span-2 lg:col-span-1">
                    <span class="text-4xl">üö™</span>
                    <p class="mt-2 text-lg font-semibold">Log out</p>
                </button>
            </div>
        </div>

        <!-- Call form -->
        <div id="callSection" class="hidden">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Log a new call</h1>
                <p class="mt-2 text-gray-500">Logged in as <span class="font-bold text-blue-600" id="callSectionCoachNameDisplay"></span>.</p>
            </div>

            <form id="callForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <!-- hidden -->
                <input type="hidden" id="coachName" name="coachName">
                <input type="hidden" id="units" name="units">
                <input type="hidden" id="allocationId" name="allocationId">
                <input type="hidden" id="productId" name="productId">

                <!-- Student -->
                <div>
                    <label for="studentId" class="form-label block mb-2">Student ID</label>
                    <select id="studentId" name="studentId" class="form-input" required>
                        <option value="" disabled selected>Loading Student IDs...</option>
                    </select>
                </div>

                <!-- Product -->
                <div>
                    <label for="productIdSelect" class="form-label block mb-2">Product ID</label>
                    <select id="productIdSelect" name="productIdSelect" class="form-input" required disabled>
                        <option value="" disabled selected>Select a Student ID first</option>
                    </select>
                </div>

                <!-- Date -->
                <div>
                    <label for="callDate" class="form-label block mb-2">Date</label>
                    <input type="date" id="callDate" name="callDate" class="form-input" required>
                </div>

                <!-- ‚Ç¨ / h -->
                <div>
                    <label for="hourlyRate" class="form-label block mb-2">Coach Rate (‚Ç¨)</label>
                    <input type="number" id="hourlyRate" name="hourlyRate" class="form-input" step="0.01" placeholder="Automatic calculation" required readonly>
                </div>

                <!-- Technical duration -->
                <div>
                    <label for="technicalDuration" class="form-label block mb-2">Duration (minutes)</label>
                    <input type="number" id="technicalDuration" name="technicalDuration" class="form-input" step="1" placeholder="Automatic calculation" required readonly>
                </div>

                <!-- Override -->
                <div>
                    <label for="callDuration" class="form-label block mb-2">Duration Override (minutes)</label>
                    <select id="callDuration" name="callDuration" class="form-input" required>
                        <option value="30">30</option>
                        <option value="60" selected>60</option>
                        <option value="90">90</option>
                        <option value="120">120</option>
                    </select>
                </div>

                <div class="md:col-span-2 mt-4">
                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Log Call</button>
                    <button type="button" id="backToDashboardBtn" class="w-full mt-2 bg-gray-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50">Back to Dashboard</button>
                </div>
            </form>

            <div id="callMessageBox" class="mt-8 p-4 rounded-xl text-center hidden"></div>
        </div>

        <!-- Students Section -->
        <div id="studentsSection" class="hidden">
            <div class="flex items-center justify-between mb-6 flex-col sm:flex-row">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 sm:mb-0">My Students</h2>
                <button id="backToDashboardFromStudentsBtn" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50">Back to Dashboard</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="studentSelect" class="form-label block mb-2">Select a Student</label>
                    <select id="studentSelect" class="form-input">
                        <option value="" disabled selected>Loading students...</option>
                    </select>
                </div>
                <div id="studentDetailsContainer" class="rounded-xl shadow-lg border border-gray-200 p-6 bg-white">
                    <p class="text-gray-500 text-center">Select a student from the dropdown to view their details.</p>
                </div>
            </div>
        </div>


        <!-- Call history -->
        <div id="callHistorySection" class="hidden">
            <div class="flex items-center justify-between mb-6 flex-col sm:flex-row">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 sm:mb-0">My Calls</h2>
                <div class="flex items-center space-x-4">
                    <select id="monthFilter" class="form-input w-48">
                        <option value="all">All months</option>
                    </select>
                    <button id="backToDashboardFromHistoryBtn" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50">Back to Dashboard</button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-xl shadow-lg border border-gray-200">
                <table class="min-w-full bg-white text-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-xs leading-normal">
                            <th class="py-3 px-6 text-left">Date</th>
                            <th class="py-3 px-6 text-left">Student ID</th>
                            <th class="py-3 px-6 text-left">Allocation ID</th>
                            <th class="py-3 px-6 text-left">Earnings</th>
                        </tr>
                    </thead>
                    <tbody id="callHistoryTableBody" class="text-gray-600 text-sm font-light"></tbody>
                </table>
            </div>

            <div id="callHistoryMessageBox" class="mt-4 p-4 rounded-xl text-center hidden"></div>
        </div>

        <!-- Report Cards Section -->
        <div id="reportCardsSection" class="hidden">
            <div class="flex items-center justify-between mb-6 flex-col sm:flex-row">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Report Cards</h2>
                <button id="backToDashboardFromReportsBtn" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50">Back to Dashboard</button>
            </div>
            <div class="text-center p-8 border-2 border-dashed border-gray-300 rounded-xl text-gray-500">
                Report Cards functionality will be added here.
            </div>
        </div>

        <!-- Modal -->
        <div id="confirmationModal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-2xl font-bold text-gray-800">Success!</h2>
                <p id="modalMessage" class="mt-4 text-gray-600"></p>
                <button id="closeModalBtn" class="mt-6 bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-blue-700">OK</button>
            </div>
        </div>

        <script>
            // URL of the Web App (Deployment -> Web app)
            const base_url = "https://vercel-python-proxy.vercel.app/api";
            const deployment_id = "AKfycbx1mAcW3zM-ONtMADPGq60rAqcpXcCAvnmNF-Wu84FTFKA35ULbw17L2lyzRIxh8cFF";

            // --- DOM References
            const loginForm = document.getElementById('loginForm');
            const callForm = document.getElementById('callForm');
            const loginBtn = document.getElementById('loginBtn');
            const submitBtn = document.getElementById('submitBtn');

            const loginSection = document.getElementById('loginSection');
            const dashboardSection = document.getElementById('dashboardSection');
            const callSection = document.getElementById('callSection');
            const studentsSection = document.getElementById('studentsSection');
            const callHistorySection = document.getElementById('callHistorySection');
            const reportCardsSection = document.getElementById('reportCardsSection');

            const logCallBtn = document.getElementById('logCallBtn');
            const viewStudentsBtn = document.getElementById('viewStudentsBtn');
            const viewFolderBtn = document.getElementById('viewFolderBtn');
            const viewCallLogBtn = document.getElementById('viewCallLogBtn');
            const viewReportCardsBtn = document.getElementById('viewReportCardsBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const backToDashboardBtn = document.getElementById('backToDashboardBtn');
            const backToDashboardFromStudentsBtn = document.getElementById('backToDashboardFromStudentsBtn');
            const backToDashboardFromHistoryBtn = document.getElementById('backToDashboardFromHistoryBtn');
            const backToDashboardFromReportsBtn = document.getElementById('backToDashboardFromReportsBtn');


            const loginMessageBox = document.getElementById('loginMessageBox');
            const callMessageBox = document.getElementById('callMessageBox');
            const callHistoryMessageBox = document.getElementById('callHistoryMessageBox');

            const studentIdSelect = document.getElementById('studentId');
            const studentSelect = document.getElementById('studentSelect');
            const studentDetailsContainer = document.getElementById('studentDetailsContainer');
            const productIdSelect = document.getElementById('productIdSelect');

            const callDateInput = document.getElementById('callDate');
            const coachNameInput = document.getElementById('coachName');
            const coachIdInput = document.getElementById('coachId');
            const passwordInput = document.getElementById('password');


            const coachNameDisplay = document.getElementById('coachNameDisplay');
            const callSectionCoachNameDisplay = document.getElementById('callSectionCoachNameDisplay');

            const hourlyRateInput = document.getElementById('hourlyRate');
            const technicalDurationInput = document.getElementById('technicalDuration');
            const callDurationSelect = document.getElementById('callDuration');
            const unitsInput = document.getElementById('units');
            const allocationIdInput = document.getElementById('allocationId');

            const confirmationModal = document.getElementById('confirmationModal');
            const modalMessage = document.getElementById('modalMessage');
            const closeModalBtn = document.getElementById('closeModalBtn');

            const earningsAmountDisplay = document.getElementById('earningsAmount');
            const callHistoryTableBody = document.getElementById('callHistoryTableBody');
            const monthFilterSelect = document.getElementById('monthFilter');

            // --- Runtime State
            let CURRENT_COACH_ID = null;
            let CURRENT_COACH_NAME = null;
            let CURRENT_ALLOCATIONS_BY_STUDENT = {}; // { studentId: [ {allocationId, productId, hourlyRate, technicalDuration, unitsLeft} ] }
            let LAST_HISTORY = []; // cache for month filter

            // --- UI Helpers
            function showMessage(box, message, isSuccess) {
                box.textContent = message;
                box.className = `mt-4 p-4 rounded-xl text-center block ${isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            }
            function hideMessage(box) {
                box.className = 'mt-4 p-4 rounded-xl text-center hidden';
                box.textContent = '';
            }
            function showModal(message) {
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
            }
            closeModalBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                callForm.reset();
                studentIdSelect.innerHTML = '<option value="" disabled selected>Loading Student IDs...</option>';
                productIdSelect.innerHTML = '<option value="" disabled selected>Select a Student ID first</option>';
                productIdSelect.disabled = true;
                callSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                fetchMonthlyEarnings(); // refresh monthly earnings
            });

            function switchSection(showId) {
                [loginSection, dashboardSection, callSection, studentsSection, callHistorySection, reportCardsSection].forEach(sec => sec.classList.add('hidden'));
                showId.classList.remove('hidden');
            }

            // --- API helpers
            async function apiGet(action, params = {}) {
                const url = new URL(base_url + "/get");
                url.searchParams.set("deployment_id", deployment_id);
                url.searchParams.set("action", action);
                Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
                const res = await fetch(url.toString());
                if (!res.ok) throw new Error(`GET ${action} failed: ${res.status}`);
                return res.json();
            }
            
            async function apiPost(action, body = {}) {
                const res = await fetch(base_url + "/post", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ deployment_id, action, ...body }),
                });
                if (!res.ok) throw new Error(`POST ${action} failed: ${res.status}`);
                return res.json();
            }

            // --- Login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage(loginMessageBox);

                // Show spinner and disable button
                const originalBtnText = loginBtn.innerHTML;
                loginBtn.innerHTML = '<div class="spinner-container"><div class="spinner-dot"></div><div class="spinner-dot"></div><div class="spinner-dot"></div></div>';
                loginBtn.disabled = true;

                const coachId = coachIdInput.value.trim();
                const password = passwordInput.value.trim();
                try {
                    const resp = await apiPost('login', { coachId, password });
                    if (!resp.success) throw new Error(resp.error || 'Login failed.');
                    CURRENT_COACH_ID = resp.coachId;
                    CURRENT_COACH_NAME = resp.coachName;

                    coachNameDisplay.textContent = CURRENT_COACH_NAME;
                    coachNameInput.value = CURRENT_COACH_NAME;
                    callSectionCoachNameDisplay.textContent = CURRENT_COACH_NAME;

                    switchSection(dashboardSection);
                    await fetchMonthlyEarnings();
                } catch (err) {
                    showMessage(loginMessageBox, err.message, false);
                } finally {
                    // Hide spinner and re-enable button
                    loginBtn.innerHTML = originalBtnText;
                    loginBtn.disabled = false;
                }
            });

            // --- Logout
            logoutBtn.addEventListener('click', () => {
                CURRENT_COACH_ID = null;
                CURRENT_COACH_NAME = null;
                LAST_HISTORY = [];
                CURRENT_ALLOCATIONS_BY_STUDENT = {};
                loginForm.reset();
                switchSection(loginSection);
                hideMessage(loginMessageBox);
            });

            // --- Load Students (for call log)
            async function loadStudentIds() {
                studentIdSelect.innerHTML = '<option value="" disabled selected>Loading Student IDs...</option>';
                try {
                    const resp = await apiGet('getStudents');
                    const arr = (resp && resp.success && Array.isArray(resp.students)) ? resp.students : [];
                    studentIdSelect.innerHTML = '';
                    const def = document.createElement('option');
                    def.value = '';
                    def.disabled = true;
                    def.selected = true;
                    def.textContent = 'Select a student';
                    studentIdSelect.appendChild(def);

                    arr.forEach(id => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = id;
                        studentIdSelect.appendChild(opt);
                    });
                } catch (err) {
                    studentIdSelect.innerHTML = '<option value="" disabled selected>Error loading</option>';
                }
            }

            // --- Select student -> load allocations/products
            studentIdSelect.addEventListener('change', async () => {
                const studentId = studentIdSelect.value;
                productIdSelect.disabled = true;
                productIdSelect.innerHTML = '<option value="" disabled selected>Loading products...</option>';
                hourlyRateInput.value = '';
                technicalDurationInput.value = '';
                allocationIdInput.value = '';

                try {
                    const resp = await apiGet('getStudentAllocations', { studentId });
                    const allocations = (resp && resp.success && Array.isArray(resp.allocations)) ? resp.allocations : [];
                    CURRENT_ALLOCATIONS_BY_STUDENT[studentId] = allocations;

                    productIdSelect.innerHTML = '';
                    const def = document.createElement('option');
                    def.value = '';
                    def.disabled = true;
                    def.selected = true;
                    def.textContent = 'Select a product/allocation';
                    productIdSelect.appendChild(def);

                    allocations.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.productId;
                        opt.textContent = `${a.productId} ‚Äî ${a.allocationId}${a.unitsLeft!==null? ` (remaining ${a.unitsLeft})`:''}`;
                        opt.dataset.allocationId = a.allocationId;
                        opt.dataset.hourlyRate = a.hourlyRate;
                        opt.dataset.technicalDuration = a.technicalDuration;
                        productIdSelect.appendChild(opt);
                    });

                    productIdSelect.disabled = false;
                } catch (err) {
                    productIdSelect.innerHTML = '<option value="" disabled selected>Error loading</option>';
                }
            });

            // --- Select product -> populate fields
            productIdSelect.addEventListener('change', () => {
                const opt = productIdSelect.options[productIdSelect.selectedIndex];
                if (!opt || !opt.dataset) return;
                hourlyRateInput.value = opt.dataset.hourlyRate || '';
                technicalDurationInput.value = opt.dataset.technicalDuration || '';
                allocationIdInput.value = opt.dataset.allocationId || '';
                // Set default callDuration = technicalDuration if present
                const tech = parseInt(technicalDurationInput.value || '60', 10);
                if ([30,60,90,120].includes(tech)) {
                    callDurationSelect.value = String(tech);
                } else {
                    callDurationSelect.value = '60';
                }
                recomputeUnits();
            });

            // --- Units = callDuration(min) / 60
            function recomputeUnits() {
                const mins = parseFloat(callDurationSelect.value || '60');
                const units = isNaN(mins) ? 1 : (mins / 60);
                unitsInput.value = units.toFixed(2);
            }
            callDurationSelect.addEventListener('change', recomputeUnits);

            // --- Submit call
            callForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage(callMessageBox);

                if (!CURRENT_COACH_ID) {
                    showMessage(callMessageBox, 'Session expired. Please log in again.', false);
                    return;
                }

                // Show spinner and disable button
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner-container"><div class="spinner-dot"></div><div class="spinner-dot"></div><div class="spinner-dot"></div></div>';
                submitBtn.disabled = true;

                const payload = {
                    studentId: studentIdSelect.value,
                    allocationId: allocationIdInput.value,
                    callDate: callDateInput.value,        // YYYY-MM-DD
                    callDuration: parseFloat(callDurationSelect.value), // minutes
                    units: parseFloat(unitsInput.value),      // hours
                    hourlyRate: parseFloat(hourlyRateInput.value),
                    coachId: CURRENT_COACH_ID,
                    coachName: CURRENT_COACH_NAME
                };

                // Minimal validations
                if (!payload.studentId || !payload.allocationId) {
                    showMessage(callMessageBox, 'Select student and product/allocation.', false);
                    // Restore button state
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const resp = await apiPost('logCall', payload);
                    if (!resp.success) throw new Error(resp.error || 'Error logging call.');
                    showModal('Call logged successfully!');
                } catch (err) {
                    showMessage(callMessageBox, err.message, false);
                } finally {
                    // Hide spinner and re-enable button
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                }
            });

            // --- Monthly earnings
            async function fetchMonthlyEarnings() {
                if (!CURRENT_COACH_ID) return;
                earningsAmountDisplay.textContent = '...';
                try {
                    const resp = await apiGet('getMonthlyEarnings', { coachId: CURRENT_COACH_ID });
                    const value = (resp && resp.success) ? resp.earnings : 0;
                    earningsAmountDisplay.textContent = Number(value).toFixed(2);
                } catch {
                    earningsAmountDisplay.textContent = '--';
                }
            }

            // --- Payment folder
            viewFolderBtn.addEventListener('click', async () => {
                if (!CURRENT_COACH_ID) return;
                try {
                    const resp = await apiGet('getPaymentFolderUrl', { coachId: CURRENT_COACH_ID });
                    if (resp && resp.success && resp.url) window.open(resp.url, '_blank');
                } catch {}
            });

            // --- Call log
            viewCallLogBtn.addEventListener('click', async () => {
                if (!CURRENT_COACH_ID) return;
                switchSection(callHistorySection);
                await loadCallHistory();
            });

            backToDashboardFromHistoryBtn.addEventListener('click', () => {
                switchSection(dashboardSection);
            });

            async function loadCallHistory() {
                callHistoryTableBody.innerHTML = '';
                monthFilterSelect.innerHTML = '<option value="all">All months</option>';
                hideMessage(callHistoryMessageBox);

                try {
                    const resp = await apiGet('getCallHistory', { coachId: CURRENT_COACH_ID });
                    const history = (resp && resp.success && Array.isArray(resp.history)) ? resp.history : [];
                    LAST_HISTORY = history;

                    // Populate month filter (yyyy-mm)
                    const months = Array.from(new Set(history.map(h => h.dateISO.slice(0,7))));
                    months.sort((a,b) => (a < b ? 1 : -1));
                    months.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        // Readable label (MMMM yyyy)
                        const [yy, mm] = m.split('-').map(Number);
                        const date = new Date(yy, mm - 1, 1);
                        opt.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        monthFilterSelect.appendChild(opt);
                    });

                    renderHistoryTable('all');
                } catch (err) {
                    showMessage(callHistoryMessageBox, 'Error loading history.', false);
                }
            }

            function renderHistoryTable(filterMonth) {
                callHistoryTableBody.innerHTML = '';
                const rows = LAST_HISTORY
                    .filter(h => filterMonth === 'all' ? true : h.dateISO.startsWith(filterMonth));

                if (!rows.length) {
                    callHistoryTableBody.innerHTML = `<tr><td class="py-3 px-6 text-left" colspan="4">No calls found.</td></tr>`;
                    return;
                }

                rows.forEach(h => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="py-3 px-6 text-left">${h.date}</td>
                        <td class="py-3 px-6 text-left">${h.studentId || ''}</td>
                        <td class="py-3 px-6 text-left">${h.allocationId || ''}</td>
                        <td class="py-3 px-6 text-left">${Number(h.earnings).toFixed(2)}‚Ç¨</td>
                    `;
                    callHistoryTableBody.appendChild(tr);
                });
            }

            monthFilterSelect.addEventListener('change', () => {
                renderHistoryTable(monthFilterSelect.value);
            });

            // --- Student Section Logic
            async function loadStudentsDropdown() {
                studentSelect.innerHTML = '<option value="" disabled selected>Loading students...</option>';
                studentDetailsContainer.innerHTML = '<p class="text-gray-500 text-center">Select a student from the dropdown to view their details.</p>';
                try {
                    const resp = await apiGet('getStudents');
                    const arr = (resp && resp.success && Array.isArray(resp.students)) ? resp.students : [];
                    studentSelect.innerHTML = '';
                    const def = document.createElement('option');
                    def.value = '';
                    def.disabled = true;
                    def.selected = true;
                    def.textContent = 'Select a student';
                    studentSelect.appendChild(def);
                    arr.forEach(id => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = id;
                        studentSelect.appendChild(opt);
                    });
                } catch (err) {
                    studentSelect.innerHTML = '<option value="" disabled selected>Error loading students.</option>';
                }
            }

            async function fetchAndRenderStudentDetails(studentId) {
                studentDetailsContainer.innerHTML = '<p class="text-gray-500 text-center">Loading student details...</p>';
                try {
                    const resp = await apiGet('getStudentInfo', { studentId });
                    if (!resp || !resp.success || !resp.studentInfo) {
                        throw new Error('Student not found.');
                    }
                    const info = resp.studentInfo;
                    const calls = info.calls || [];
                    delete info.calls;

                    // Fields to be excluded from the details table
                    const hiddenFields = [
                        'Report Cards Recurrency',
                        'Report Card Recipient',
                        'Global start reporting',
                        'Last reported date',
                        'Next start reporting',
                        'Next end reporting',
                        'Bulletin Board'
                    ];

                    // Fields to be rendered as buttons
                    const linkFields = {
                        'Quizlet Link': 'Quizlet',
                        'Drive Folder Link': 'Drive Folder',
                        'Homework File': 'Homework File',
                        'Lesson Plan File': 'Lesson Plan'
                    };
                    
                    let detailsHtml = '';
                    let buttonsHtml = '';

                    // First, render the links as buttons
                    for (const [key, value] of Object.entries(info)) {
                        if (linkFields[key]) {
                            const buttonLabel = linkFields[key];
                            const linkUrl = value || '';
                            const isDisabled = !linkUrl || linkUrl.trim() === 'N/A';
                            
                            buttonsHtml += `
                                <a href="${isDisabled ? '#' : linkUrl}" 
                                   target="${isDisabled ? '' : '_blank'}"
                                   class="inline-block px-4 py-2 rounded-lg font-semibold transition duration-300 ease-in-out transform hover:scale-105
                                   ${isDisabled ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}"
                                   ${isDisabled ? 'onclick="event.preventDefault()"' : ''}>
                                   ${buttonLabel}
                                </a>
                            `;
                        }
                    }

                    // Then, render the other details in a table
                    detailsHtml += `<h3 class="text-xl font-semibold text-gray-800 mb-4">Student Details</h3><div class="overflow-x-auto mb-6"><table class="w-full text-sm"><tbody>`;
                    for (const [key, value] of Object.entries(info)) {
                        if (!hiddenFields.includes(key) && !linkFields[key]) {
                            detailsHtml += `
                                <tr>
                                    <td class="py-3 px-6 font-medium text-gray-700 whitespace-nowrap">${key}</td>
                                    <td class="py-3 px-6 text-gray-800">${value || 'N/A'}</td>
                                </tr>
                            `;
                        }
                    }
                    detailsHtml += `</tbody></table></div>`;

                    // Render call history table
                    detailsHtml += `<h3 class="text-xl font-semibold text-gray-800 mb-4">Call History</h3><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-200 text-gray-600 uppercase text-xs leading-normal"><th class="py-3 px-6 text-left">Date</th><th class="py-3 px-6 text-left">Allocation ID</th><th class="py-3 px-6 text-left">Units</th><th class="py-3 px-6 text-left">Earnings</th></tr></thead><tbody>`;
                    if (calls.length > 0) {
                        calls.forEach(c => {
                            detailsHtml += `
                                <tr>
                                    <td class="py-3 px-6 text-left">${c.callDate || 'N/A'}</td>
                                    <td class="py-3 px-6 text-left">${c.allocationId || 'N/A'}</td>
                                    <td class="py-3 px-6 text-left">${c.units || 'N/A'}</td>
                                    <td class="py-3 px-6 text-left">${(c.units * c.hourlyRate).toFixed(2)}‚Ç¨</td>
                                </tr>
                            `;
                        });
                    } else {
                        detailsHtml += `<tr><td class="py-3 px-6 text-center text-gray-500" colspan="4">No calls found for this student.</td></tr>`;
                    }
                    detailsHtml += `</tbody></table></div>`;

                    let contentHtml = '';
                    if (buttonsHtml.length > 0) {
                        contentHtml += `<div class="mb-6"><h3 class="text-xl font-semibold text-gray-800 mb-4">Link Utili</h3><div class="flex flex-wrap gap-4">${buttonsHtml}</div></div>`;
                    }
                    contentHtml += detailsHtml;

                    studentDetailsContainer.innerHTML = contentHtml;

                } catch (err) {
                    studentDetailsContainer.innerHTML = `<p class="text-red-500 text-center">Error: ${err.message}</p>`;
                }
            }

            studentSelect.addEventListener('change', (e) => {
                const studentId = e.target.value;
                if (studentId) {
                    fetchAndRenderStudentDetails(studentId);
                }
            });

            viewStudentsBtn.addEventListener('click', () => {
                if (!CURRENT_COACH_ID) return;
                switchSection(studentsSection);
                loadStudentsDropdown();
            });

            backToDashboardFromStudentsBtn.addEventListener('click', () => {
                switchSection(dashboardSection);
            });
            backToDashboardFromReportsBtn.addEventListener('click', () => {
                switchSection(dashboardSection);
            });
            viewReportCardsBtn.addEventListener('click', () => {
                switchSection(reportCardsSection);
            });
        </script>
    </div>
</body>
</html>
